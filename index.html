<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Ping Identity</title>
  <link rel="shortcut icon" href="favicon.ico">
  <link id="ui-library-css" rel="stylesheet" type="text/css"
    href="https://assets.pingone.com/ux/ui-library/4.40.1/css/ui-library.css">
  <link rel="stylesheet" type="text/css" href="styles/content-iframe.css?v=7mJOLw4DONH98Rk2lI4EU" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #f4f6fb;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: row;
    }

    .sidebar {
      background: #394667;
      color: #fff;
      width: 240px;
      min-width: 240px;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.04);
      z-index: 10;
    }

    .sidebar-logo {
      width: 100%;
      height: 48px;
      background: #394667;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      border-right: 1px solid #fff;
      border-bottom: 1px solid #fff;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .sidebar-logo img {
      height: 32px;
      width: auto;
      margin-left: 16px;
      display: block;
    }

    .sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-top: 2rem;
    }

    .sidebar-nav .nav-section {
      margin-bottom: 1.5rem;
    }

    .sidebar-nav .nav-title {
      font-size: 0.85rem;
      color: #a0aec0;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 0 0 0.5rem 2rem;
    }

    .sidebar-nav .nav-link {
      display: flex;
      align-items: center;
      padding: 0.7rem 2rem;
      color: #fff;
      text-decoration: none;
      font-size: 1rem;
      border-left: 3px solid transparent;
      transition: background 0.2s, border-color 0.2s;
      border-radius: 4px 0 0 4px;
      margin-bottom: 2px;
    }

    .sidebar-nav .nav-link.active,
    .sidebar-nav .nav-link:hover {
      background: #2d2e4a;
      border-left: 3px solid #e60028;
      color: #e60028;
    }

    .main-content {
      flex: 1;
      margin-left: 240px;
      width: 100%;
      display: flex;
      flex-direction: column;
      background: #f4f6fb;
      min-height: 100vh;
    }

    .main-header {
      background: #fff;
      padding: 1.2rem 2.5rem 1.2rem 2.5rem;
      border-bottom: 1px solid #e5e7eb;
      font-size: 1.2rem;
      font-weight: 500;
      color: #22223b;
      display: flex;
      align-items: center;
      min-height: 64px;
    }

    .portal-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      padding: 2.5rem 1.2rem 3.5rem 1.2rem;
      max-width: 1100px;
      width: auto;
      margin: 2.5rem auto 1.5rem auto;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 2rem;
      margin: 0 0 0.5rem 0;
      color: #0033a0;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .portal-desc {
      color: #374151;
      font-size: 1.1rem;
      margin-bottom: 2rem;
    }

    .file-input {
      margin: 1.5rem 0 1rem 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: 100%;
    }

    input[type="file"] {
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      font-size: 1rem;
      margin-bottom: 1rem;
      width: 100%;
      max-width: 350px;
    }

    .primary-btn {
      background: #a92d32;
      color: #fff;
      border: none;
      border-radius: 2px;
      padding: 0.7rem 2.2rem;
      font-size: 1.3rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, border 0.2s;
      line-height: normal;
      text-align: center;
      display: inline-block;
      vertical-align: middle;
      box-shadow: none;
      letter-spacing: 0;
      min-height: 3.1rem;
    }

    .primary-btn:hover {
      background: #ff4d6d;
      color: #fff;
      border: none;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      font-size: 1rem;
      table-layout: fixed;
      word-break: break-word;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }

    .results-table th,
    .results-table td {
      padding: 0.7rem 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    .results-table th {
      background: #f1f5f9;
      color: #374151;
      font-weight: 600;
    }

    .results-table td.error-cell {
      white-space: pre-wrap;
      word-break: break-word;
      max-width: 400px;
      color: #b8001c;
    }

    .status-success {
      color: #16a34a;
      font-weight: 600;
    }

    .status-error {
      color: #e60028;
      font-weight: 600;
    }

    .pingone-footer {
      background: #22223b;
      color: #fff;
      font-size: 1rem;
      text-align: center;
      letter-spacing: 0.2px;
      padding: 1.2rem 0 1.2rem 0;
      margin-top: auto;
    }

    .pingone-footer strong {
      color: #e60028;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    @media (max-width: 900px) {
      .portal-card {
        max-width: 98vw;
      }

      .main-content {
        margin-left: 240px;
      }

      .results-table th,
      .results-table td {
        font-size: 0.92rem;
      }

      .results-table td.error-cell {
        max-width: 200px;
      }

      .ping-header .logo {
        margin-left: 10px;
      }
    }

    @media (max-width: 600px) {
      .sidebar {
        width: 120px;
        min-width: 120px;
      }

      .main-content {
        margin-left: 120px;
      }

      .sidebar-logo,
      .sidebar-logo img {
        width: 80px;
        height: 32px;
      }
    }

    .sidebar-action {
      background: none;
      color: #fff;
      font-size: 1.05rem;
      padding: 1rem 0.5rem;
      margin: 0.5rem 0;
      text-align: center;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      outline: none;
      user-select: none;
    }

    .sidebar-action:hover,
    .sidebar-action:focus {
      background: #e60028;
      color: #fff;
    }

    #rememberClientSecret {
      width: 1.3rem;
      height: 1.3rem;
      background: #fff;
      border: 2px solid #e60028;
      border-radius: 4px;
      outline: 2px solid #e60028;
      box-shadow: 0 0 0 2px #fff;
      margin-right: 0.5rem;
      vertical-align: middle;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      position: relative;
      cursor: pointer;
      display: inline-block;
    }

    #rememberClientSecret:checked::after {
      content: '\2714';
      color: #e60028;
      font-size: 1.1rem;
      position: absolute;
      left: 0.18rem;
      top: 0.02rem;
      font-weight: bold;
      pointer-events: none;
    }

    #rememberClientSecret:focus {
      outline: 2px solid #e60028;
      border-color: #e60028;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <div class="sidebar-logo"
      style="background:#fff;padding:0.7rem 0.7rem 0.7rem 0.7rem;border-radius:12px;margin:1.2rem 0 0.5rem 0;box-sizing:border-box;display:flex;align-items:center;justify-content:center;width:calc(100% - 0.7rem*2);">
      <img src="https://github.com/curtismu7/CDN/blob/main/Ping%20Identity_idEzgMTpXK_2.png?raw=true"
        alt="Ping Identity Logo">
    </div>
    <div class="sidebar-nav">
      <div class="sidebar-action" id="chooseFileSidebar" tabindex="0" onclick="triggerFileInput()">Choose File</div>
      <span id="sidebarFileName"
        style="margin:0.2rem 0 0.7rem 0; color:#e60028; font-size:0.97rem; display:block; text-align:center; word-break:break-all;"></span>
      <div class="sidebar-action" id="importUsersSidebar" tabindex="0" onclick="uploadCSV()">Import Users</div>
    </div>
  </div>
  <div class="main-content">
    <div
      style="width:100%;background:#e60028;color:#fff;font-size:1.35rem;font-weight:700;text-align:center;padding:1.1rem 0 1.1rem 0;letter-spacing:0.5px;">
      Ping Identity - Not supported</div>
    <div class="main-header">
      Applications &gt; User Import Portal
    </div>
    <div class="portal-card">
      <h1 style="margin-bottom:1.5rem;">Import Users from CSV</h1>
      <div class="portal-desc">Upload your <strong><span id="headerFileName"
            style="color:#e60028;font-size:1.25em;">file with users and extension of .csv file</span></strong> file to
        import users into PingOne</div>
      <div class="file-input">
        <div
          style="background:#f8fafc;border:1.5px solid #cbd5e1;border-radius:12px;padding:1.5rem 1.5rem 1rem 1.5rem;margin-bottom:1.2rem;width:100%;max-width:700px;box-sizing:border-box;display:flex;flex-direction:column;align-items:center;margin-left:auto;margin-right:auto;">
          <div style="display:flex;align-items:center;gap:0.5rem;width:100%;max-width:500px;margin-bottom:0.5rem;">
            <input type="text" id="envIdInput" placeholder="Enter Environment ID"
              style="flex:1;padding:0.5rem;border-radius:6px;border:1px solid #cbd5e1;background:#f3f4f6;font-size:1rem;max-width:500px;width:100%;" />
            <button id="clearEnvIdBtn" type="button"
              style="background:#e5e7eb;color:#0033a0;border:none;border-radius:6px;padding:0.5rem 0.9rem;font-size:1.1rem;cursor:pointer;transition:background 0.2s;">&times;</button>
          </div>
          <div style="display:flex;align-items:center;gap:0.5rem;width:100%;max-width:500px;margin-bottom:0.5rem;">
            <input type="text" id="clientIdInput" placeholder="Enter Client ID"
              style="flex:1;padding:0.5rem;border-radius:6px;border:1px solid #cbd5e1;background:#f3f4f6;font-size:1rem;max-width:500px;width:100%;" />
            <button id="clearClientIdBtn" type="button"
              style="background:#e5e7eb;color:#0033a0;border:none;border-radius:6px;padding:0.5rem 0.9rem;font-size:1.1rem;cursor:pointer;transition:background 0.2s;">&times;</button>
          </div>
          <div
            style="display:flex;align-items:center;gap:0.5rem;width:100%;max-width:500px;margin-bottom:0.5rem;position:relative;">
            <input type="password" id="clientSecretInput" placeholder="Enter Client Secret"
              style="flex:1;padding:0.5rem;border-radius:6px;border:1px solid #cbd5e1;background:#f3f4f6;font-size:1rem;max-width:500px;width:100%;transition:width 0.2s;" />
            <span id="clientSecretSizer"
              style="visibility:hidden;position:absolute;white-space:pre;font-size:1rem;font-family:inherit;padding:0.5rem;border-radius:6px;"></span>
            <button id="clearClientSecretBtn" type="button"
              style="background:#e5e7eb;color:#0033a0;border:none;border-radius:6px;padding:0.5rem 0.9rem;font-size:1.1rem;cursor:pointer;transition:background 0.2s;">&times;</button>
            <button id="toggleSecretBtn" type="button"
              style="background:none;border:none;position:absolute;right:2.5rem;top:50%;transform:translateY(-50%);padding:0.3rem;cursor:pointer;outline:none;">
              <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
                fill="none" stroke="#0033a0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3" />
                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z" />
              </svg>
            </button>
          </div>
          <div
            style="width:100%;max-width:500px;display:flex;align-items:center;margin-bottom:0.5rem;margin-top:0.5rem;justify-content:center;">
            <input type="checkbox" id="rememberClientSecret" style="margin-right:0.5rem;" />
            <label for="rememberClientSecret" style="font-size:1rem;color:#374151;cursor:pointer;">Remember client
              secret</label>
          </div>
        </div>
        <div
          style="background:#f8fafc;border:1.5px solid #cbd5e1;border-radius:12px;padding:1.5rem 1.5rem 1.5rem 1.5rem;margin-bottom:1.2rem;width:100%;max-width:700px;box-sizing:border-box;display:flex;flex-direction:column;align-items:center;margin-left:auto;margin-right:auto;">
          <div style="width:100%;max-width:350px;">
            <input type="file" id="csvFile" accept=".csv"
              style="padding:0.7rem 0.9rem;border-radius:7px;border:1.5px solid #cbd5e1;background:#f8fafc;font-size:1.13rem;max-width:370px;width:100%;margin-bottom:0.7rem;color:#e60028;" />
          </div>
          <div style="width:100%;max-width:350px;display:flex;justify-content:center;">
            <button class="primary-btn" onclick="uploadCSV()" id="importUsersBtn"
              style="margin-top:1.2rem;padding:0.7rem 2.2rem;width:auto;background:#fff;color:#e60028;border:2px solid #e60028;transition:background 0.2s,color 0.2s;">Import
              Users</button>
          </div>
          <div id="importStatus"
            style="margin-top:1.1rem;width:100%;max-width:370px;text-align:left;font-size:1.08rem;color:#0033a0;font-weight:500;display:none;background:#f6fafd;border:1.5px solid #d1e3f8;border-radius:10px;padding:1.1rem 1.2rem 1.1rem 1.2rem;box-shadow:0 2px 8px rgba(0,32,128,0.06);">
          </div>
        </div>
      </div>
      <div id="resultsSection" style="display:none;width:100%;">
        <h2 style="font-size:1.2rem;color:#0033a0;margin-bottom:0.5rem;text-align:left;">Results</h2>
        <button id="deleteAllUsersBtn" class="primary-btn" style="margin-bottom:1rem;background:#e60028;color:#fff;" onclick="deleteAllUsers()">Delete All Users</button>
        <table class="results-table" id="resultsTable" style="table-layout:fixed;width:100%;min-width:700px;">
          <colgroup>
            <col style="width:18%">
            <col style="width:14%">
            <col style="width:48%">
            <col style="width:20%">
            <col style="width:12%">
          </colgroup>
          <tr>
            <th>Username</th>
            <th>Status</th>
            <th>Error</th>
            <th>Debug</th>
            <th>Action</th>
          </tr>
        </table>
      </div>
    </div>
    <div class="pingone-footer">
      &copy; 2024 <strong>Ping Identity</strong>. All rights reserved.
    </div>
  </div>
  <div id="spinnerOverlay"
    style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.75);z-index:9999;display:flex;align-items:center;justify-content:center;">
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;">
      <div class="spinner"
        style="border:6px solid #e5e7eb;border-top:6px solid #e60028;border-radius:50%;width:64px;height:64px;animation:spin 1s linear infinite;">
      </div>
      <div style="margin-top:1.2rem;font-size:1.25rem;color:#0033a0;font-weight:600;text-align:center;width:100%;">
        Importing users...</div>
    </div>
  </div>
  <script>
    // On page load, prefill the environmentId, clientId, and clientSecret if saved
    window.addEventListener('DOMContentLoaded', function () {
      const envIdInput = document.getElementById('envIdInput');
      const clientIdInput = document.getElementById('clientIdInput');
      const clientSecretInput = document.getElementById('clientSecretInput');
      const rememberSecretCheckbox = document.getElementById('rememberClientSecret');
      const savedEnvId = localStorage.getItem('pingone_env_id');
      const savedClientId = localStorage.getItem('pingone_client_id');
      const savedClientSecret = localStorage.getItem('pingone_client_secret');
      const rememberSecret = localStorage.getItem('pingone_remember_client_secret') === 'true';
      // Update file name in header and sidebar when file is chosen
      var fileInput = document.getElementById('csvFile');
      var sidebarFileName = document.getElementById('sidebarFileName');
      var headerFileName = document.getElementById('headerFileName');
      if (fileInput) {
        fileInput.addEventListener('change', function () {
          if (fileInput.files && fileInput.files.length > 0) {
            var name = fileInput.files[0].name;
            if (sidebarFileName) sidebarFileName.textContent = name;
            if (headerFileName) headerFileName.textContent = name;
          } else {
            if (sidebarFileName) sidebarFileName.textContent = '';
            if (headerFileName) headerFileName.textContent = 'file with users and extension of .csv file';
          }
        });
      }
      if (envIdInput && savedEnvId) envIdInput.value = savedEnvId;
      if (clientIdInput && savedClientId) clientIdInput.value = savedClientId;
      if (rememberSecretCheckbox) rememberSecretCheckbox.checked = rememberSecret;
      if (clientSecretInput) {
        if (rememberSecret && savedClientSecret) {
          clientSecretInput.value = savedClientSecret;
        } else {
          clientSecretInput.value = '';
        }
      }
      // Add clear button handlers
      const clearEnvBtn = document.getElementById('clearEnvIdBtn');
      if (clearEnvBtn && envIdInput) clearEnvBtn.onclick = function () { envIdInput.value = ''; localStorage.removeItem('pingone_env_id'); };
      const clearClientIdBtn = document.getElementById('clearClientIdBtn');
      if (clearClientIdBtn && clientIdInput) clearClientIdBtn.onclick = function () { clientIdInput.value = ''; localStorage.removeItem('pingone_client_id'); };
      const clearClientSecretBtn = document.getElementById('clearClientSecretBtn');
      if (clearClientSecretBtn && clientSecretInput) clearClientSecretBtn.onclick = function () { clientSecretInput.value = ''; localStorage.removeItem('pingone_client_secret'); };
      if (rememberSecretCheckbox) {
        rememberSecretCheckbox.addEventListener('change', function () {
          localStorage.setItem('pingone_remember_client_secret', rememberSecretCheckbox.checked ? 'true' : 'false');
          if (rememberSecretCheckbox.checked && clientSecretInput && clientSecretInput.value) {
            localStorage.setItem('pingone_client_secret', clientSecretInput.value);
          } else {
            localStorage.removeItem('pingone_client_secret');
            if (clientSecretInput) clientSecretInput.value = '';
          }
        });
        // Also save client secret on input if checkbox is checked
        if (clientSecretInput) {
          clientSecretInput.addEventListener('input', function () {
            if (rememberSecretCheckbox.checked) {
              localStorage.setItem('pingone_client_secret', clientSecretInput.value);
            }
          });
        }
      }
      const toggleSecretBtn = document.getElementById('toggleSecretBtn');
      const eyeIcon = document.getElementById('eyeIcon');
      if (toggleSecretBtn && clientSecretInput) {
        toggleSecretBtn.onclick = function () {
          if (clientSecretInput.type === 'password') {
            clientSecretInput.type = 'text';
            eyeIcon.innerHTML = '<circle cx="12" cy="12" r="3"/><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/><line x1="4" y1="4" x2="20" y2="20" stroke="#e60028" stroke-width="2"/>';
          } else {
            clientSecretInput.type = 'password';
            eyeIcon.innerHTML = '<circle cx="12" cy="12" r="3"/><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/>';
          }
        };
      }
      const clientSecretSizer = document.getElementById('clientSecretSizer');
      function adjustSecretWidth() {
        if (!clientSecretInput || !clientSecretSizer) return;
        clientSecretSizer.textContent = clientSecretInput.value || clientSecretInput.placeholder || '';
        const minWidth = 0.98 * clientSecretInput.parentElement.offsetWidth;
        const sizerWidth = clientSecretSizer.offsetWidth + 32;
        clientSecretInput.style.width = Math.max(minWidth, sizerWidth) + 'px';
      }
      if (clientSecretInput && clientSecretSizer) {
        clientSecretInput.addEventListener('input', adjustSecretWidth);
        window.addEventListener('resize', adjustSecretWidth);
        adjustSecretWidth();
      }
      // Explicitly hide spinner on load
      var spinnerOverlay = document.getElementById('spinnerOverlay');
      if (spinnerOverlay) spinnerOverlay.style.display = 'none';
    });
    function saveToLocalStorage(envId, clientId, clientSecret) {
      localStorage.setItem('pingone_env_id', envId);
      localStorage.setItem('pingone_client_id', clientId);
      const rememberSecretCheckbox = document.getElementById('rememberClientSecret');
      if (rememberSecretCheckbox && rememberSecretCheckbox.checked) {
        localStorage.setItem('pingone_client_secret', clientSecret);
        localStorage.setItem('pingone_remember_client_secret', 'true');
      } else {
        localStorage.removeItem('pingone_client_secret');
        localStorage.setItem('pingone_remember_client_secret', 'false');
      }
    }
    function triggerFileInput() {
      document.getElementById('csvFile').click();
    }
    document.getElementById('csvFile').addEventListener('change', function () {
      const fileInput = document.getElementById('csvFile');
      const sidebarFileName = document.getElementById('sidebarFileName');
      const headerFileName = document.getElementById('headerFileName');
      if (fileInput.files.length) {
        sidebarFileName.textContent = fileInput.files[0].name;
        if (headerFileName) headerFileName.textContent = fileInput.files[0].name;
      } else {
        sidebarFileName.textContent = '';
        if (headerFileName) headerFileName.textContent = 'file with users and extension of .csv file';
      }
    });

    function getErrorCode(error) {
      if (!error) return '';
      try {
        const errObj = typeof error === 'string' ? JSON.parse(error) : error;
        if (errObj.details && Array.isArray(errObj.details) && errObj.details.length > 0) {
          return errObj.details[0].code;
        }
        if (errObj.code) {
          return errObj.code;
        }
        return '';
      } catch (e) {
        return '';
      }
    }

    function uploadCSV() {
      const fileInput = document.getElementById('csvFile');
      const envIdInput = document.getElementById('envIdInput');
      const clientIdInput = document.getElementById('clientIdInput');
      const clientSecretInput = document.getElementById('clientSecretInput');
      const spinner = document.getElementById('spinnerOverlay');
      const importBtn = document.getElementById('importUsersBtn');
      const statusDiv = document.getElementById('importStatus');
      const rememberSecretCheckbox = document.getElementById('rememberClientSecret');
      if (statusDiv) {
        statusDiv.style.display = 'none';
        statusDiv.textContent = '';
      }
      // Validation errors shown in status area, not alert
      if (!fileInput.files.length) {
        if (statusDiv) {
          statusDiv.style.display = 'block';
          statusDiv.innerHTML = `<span style='color:#e60028;'>Please select a CSV file.</span>`;
        }
        return;
      }
      // Check for blank (empty) file
      const selectedFile = fileInput.files[0];
      if (selectedFile.size === 0) {
        if (statusDiv) {
          statusDiv.style.display = 'block';
          statusDiv.innerHTML = `<span style='color:#e60028;'>The selected CSV file is blank.</span>`;
        }
        return;
      }
      if (!envIdInput.value.trim()) {
        if (statusDiv) {
          statusDiv.style.display = 'block';
          statusDiv.innerHTML = `<span style='color:#e60028;'>Please enter your PingOne Environment ID.</span>`;
        }
        return;
      }
      if (!clientIdInput.value.trim()) {
        if (statusDiv) {
          statusDiv.style.display = 'block';
          statusDiv.innerHTML = `<span style='color:#e60028;'>Please enter your PingOne Client ID.</span>`;
        }
        return;
      }
      if (!clientSecretInput.value.trim()) {
        if (statusDiv) {
          statusDiv.style.display = 'block';
          statusDiv.innerHTML = `<span style='color:#e60028;'>Please enter your PingOne Client Secret.</span>`;
        }
        return;
      }
      const envId = envIdInput.value.trim();
      const clientId = clientIdInput.value.trim();
      const clientSecret = clientSecretInput.value.trim();
      // saveToLocalStorage(envId, clientId, clientSecret);
      const formData = new FormData();
      formData.append('csv', fileInput.files[0]);
      formData.append('environmentId', envId);
      formData.append('clientId', clientId);
      formData.append('clientSecret', clientSecret);
      if (spinner) spinner.style.display = 'flex';
      if (importBtn) importBtn.disabled = true;
      if (statusDiv) {
        statusDiv.style.display = 'none';
        statusDiv.textContent = '';
      }
      fetch('http://localhost:3001/import-users', {
        method: 'POST',
        body: formData
      })
        .then(async res => {
          if (!res.body || !window.TextDecoder) {
            // fallback to old way if streaming not supported
            return res.json();
          }
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          let gotWorkerToken = false;
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            let lines = buffer.split('\n');
            buffer = lines.pop(); // last line may be incomplete
            for (const line of lines) {
              if (!line.trim()) continue;
              try {
                const msg = JSON.parse(line);
                if (msg.progress === 'got_worker_token') {
                  gotWorkerToken = true;
                  // Update spinner text
                  const spinnerText = document.querySelector('#spinnerOverlay div[style*="font-size:1.25rem"]');
                  if (spinnerText) spinnerText.textContent = 'Got Worker Token';
                } else if (msg.progress === 'importing_users') {
                  // Update spinner text to importing users, with count if present
                  const spinnerText = document.querySelector('#spinnerOverlay div[style*="font-size:1.25rem"]');
                  if (spinnerText) {
                    if (typeof msg.imported === 'number') {
                      spinnerText.textContent = `Importing users... (${msg.imported} imported)`;
                    } else {
                      spinnerText.textContent = 'Importing users...';
                    }
                  }
                } else if (Array.isArray(msg)) {
                  // Final report
                  return msg;
                }
              } catch (e) { /* ignore */ }
            }
          }
          // If buffer has final JSON
          if (buffer.trim()) {
            try {
              const msg = JSON.parse(buffer);
              if (Array.isArray(msg)) return msg;
            } catch (e) { }
          }
          return [];
        })
        .then(report => {
          if (report && typeof report === 'object' && report.error) {
            // Backend returned an error object
            if (spinner) spinner.style.display = 'none';
            if (importBtn) importBtn.disabled = false;
            if (statusDiv) {
              statusDiv.style.display = 'block';
              statusDiv.innerHTML = `<span style='color:#e60028;'>Import failed: ${report.error}</span>`;
            }
            // Hide results section if present
            const section = document.getElementById('resultsSection');
            if (section) section.style.display = 'none';
            return;
          }
          // PAGINATION LOGIC STARTS HERE
          window._importResults = report;
          window._importPage = 1;
          renderResultsPage();
          if (spinner) spinner.style.display = 'none';
          if (importBtn) {
            importBtn.style.background = '#e60028';
            importBtn.style.color = '#fff';
            importBtn.style.border = '2px solid #e60028';
            importBtn.disabled = false;
          }
        })
    }

    function renderResultsPage(page) {
      const results = window._importResults || [];
      const table = document.getElementById('resultsTable');
      const section = document.getElementById('resultsSection');
      const statusDiv = document.getElementById('importStatus');
      if (!results.length) { section.style.display = 'none'; return; }
      section.style.display = 'block';
      // Pagination settings
      const firstPageSize = 15;
      const otherPageSize = 20;
      const currentPage = typeof page === 'number' ? page : (window._importPage || 1);
      window._importPage = currentPage;
      let startIdx = 0, endIdx = 0;
      if (currentPage === 1) {
        startIdx = 0;
        endIdx = Math.min(firstPageSize, results.length);
      } else {
        startIdx = firstPageSize + (currentPage - 2) * otherPageSize;
        endIdx = Math.min(startIdx + otherPageSize, results.length);
      }
      // Table header
      table.innerHTML = '<tr><th>Username</th><th>Status</th><th>Error</th><th>Debug</th><th>Action</th></tr>';
      let successCount = 0;
      let errorCount = 0;
      results.forEach(row => {
        if (row.status === 'created') successCount++;
        else errorCount++;
      });
      // Render only current page
      for (let idx = startIdx; idx < endIdx; ++idx) {
        const row = results[idx];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.username}</td>
          <td class="${row.status === 'created' ? 'status-success' : 'status-error'}">${row.status}</td>
          <td class="error-cell" style="word-break:break-all;white-space:normal;">${row.error ? getErrorCode(row.error) : ''}</td>
          <td>
            <button onclick="toggleDebug(${idx})" style="padding:0.2rem 0.7rem;font-size:0.95rem;">Show Debug</button>
          </td>
          <td>
            <button onclick="deleteUser('${row.username}', this)" style="padding:0.2rem 0.7rem;font-size:0.95rem;background:#e60028;color:#fff;border:none;border-radius:4px;cursor:pointer;">Delete</button>
          </td>
        `;
        table.appendChild(tr);
        const debugTr = document.createElement('tr');
        debugTr.id = `debug-row-${idx}`;
        debugTr.style.display = 'none';
        let debugContent = '';
        if (row.error) {
          debugContent += '<b>Error:</b>\n' + (typeof row.error === 'string' ? row.error : JSON.stringify(row.error, null, 2)) + '\n\n';
        }
        if (row.debug && row.debug.sentData) {
          debugContent += '<b>Sent Data:</b>\n' + JSON.stringify(row.debug.sentData, null, 2);
        }
        debugTr.innerHTML = `
          <td colspan="5" style="background:#f9fafb; color:#222; font-size:0.95rem; border-top:1px solid #e5e7eb;">
            <pre style="white-space:pre-wrap;word-break:break-all;margin:0;">${debugContent || 'No debug info'}</pre>
          </td>
        `;
        table.appendChild(debugTr);
      }
      // Pagination controls
      const navDivId = 'resultsNavDiv';
      let navDiv = document.getElementById(navDivId);
      if (!navDiv) {
        navDiv = document.createElement('div');
        navDiv.id = navDivId;
        navDiv.style = 'display:flex;gap:1.2em;justify-content:center;align-items:center;margin:1.2em 0 0.5em 0;font-size:1.08rem;';
        section.appendChild(navDiv);
      }
      navDiv.innerHTML = '';
      const totalPages = results.length <= firstPageSize ? 1 : 1 + Math.ceil((results.length - firstPageSize) / otherPageSize);
      // Pagination button style
      const pageBtnStyle = 'background:#fff;color:#e60028;border:2px solid #e60028;border-radius:6px;padding:0.5rem 1.2rem;font-size:1.08rem;font-weight:600;cursor:pointer;transition:background 0.2s,color 0.2s;margin:0 0.2em;';
      const pageBtnHover = 'this.style.background=\'#e60028\';this.style.color=\'#fff\'';
      const pageBtnOut = 'this.style.background=\'#fff\';this.style.color=\'#e60028\'';
      // Previous button
      if (currentPage > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.textContent = 'Previous';
        prevBtn.setAttribute('style', pageBtnStyle);
        prevBtn.setAttribute('onmouseover', pageBtnHover);
        prevBtn.setAttribute('onmouseout', pageBtnOut);
        prevBtn.onclick = () => renderResultsPage(currentPage - 1);
        navDiv.appendChild(prevBtn);
      }
      // Next button
      if (currentPage < totalPages) {
        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Next Page';
        nextBtn.setAttribute('style', pageBtnStyle);
        nextBtn.setAttribute('onmouseover', pageBtnHover);
        nextBtn.setAttribute('onmouseout', pageBtnOut);
        nextBtn.onclick = () => renderResultsPage(currentPage + 1);
        navDiv.appendChild(nextBtn);
      }
      // Last page button
      if (currentPage < totalPages) {
        const lastBtn = document.createElement('button');
        lastBtn.textContent = 'Last Page';
        lastBtn.setAttribute('style', pageBtnStyle);
        lastBtn.setAttribute('onmouseover', pageBtnHover);
        lastBtn.setAttribute('onmouseout', pageBtnOut);
        lastBtn.onclick = () => renderResultsPage(totalPages);
        navDiv.appendChild(lastBtn);
      }
      // Page indicator
      const pageInfo = document.createElement('span');
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      navDiv.appendChild(pageInfo);
      // Always show navDiv at the end
      section.appendChild(navDiv);
      // Status box (import complete)
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
          <div style="background:#fafdff;border:2px solid #b8d2f6;border-radius:12px;padding:1.1em 1.2em 1.2em 1.2em;max-width:420px;margin:0 auto;">
            <div style='font-size:1.28rem;font-weight:600;color:#1a237e;letter-spacing:0.01em;text-align:center;margin-bottom:0.55em;'>Import complete</div>
            <div style='display:flex;gap:2.2em;align-items:center;font-size:1.08rem;font-weight:500;justify-content:center;'>
              <span style="white-space:nowrap;color:#008a00;font-weight:600;"><span style='font-size:1.13em;'>${successCount}</span> user${successCount !== 1 ? 's' : ''} imported</span>
              <span style="height:1.2em;width:1.5px;background:#d1e3f8;display:inline-block;border-radius:2px;"></span>
              <span style="white-space:nowrap;color:#e60028;font-weight:600;"><span style='font-size:1.13em;'>${errorCount}</span> error${errorCount !== 1 ? 's' : ''}</span>
            </div>
          </div>
        `;
      }
    }

    function toggleDebug(idx) {
      const debugRow = document.getElementById(`debug-row-${idx}`);
      if (debugRow) {
        debugRow.style.display = debugRow.style.display === 'none' ? '' : 'none';
      }
    }

    // Add deleteUser and deleteAllUsers functions
    function deleteUser(username, btn) {
      if (!confirm(`Delete user '${username}' from CSV?`)) return;
      btn.disabled = true;
      fetch(`http://localhost:3001/users/${encodeURIComponent(username)}`, {
        method: 'DELETE'
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Remove the row from the UI
            const tr = btn.closest('tr');
            if (tr) tr.remove();
          } else {
            alert(data.error || 'Failed to delete user');
            btn.disabled = false;
          }
        })
        .catch(() => {
          alert('Failed to delete user');
          btn.disabled = false;
        });
    }

    function deleteAllUsers() {
      if (!confirm('Delete ALL users from CSV? This cannot be undone.')) return;
      const btn = document.getElementById('deleteAllUsersBtn');
      btn.disabled = true;
      fetch('http://localhost:3001/users', {
        method: 'DELETE'
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Clear the table UI
            const table = document.getElementById('resultsTable');
            table.innerHTML = '<tr><th>Username</th><th>Status</th><th>Error</th><th>Debug</th><th>Action</th></tr>';
          } else {
            alert(data.error || 'Failed to delete all users');
            btn.disabled = false;
          }
        })
        .catch(() => {
          alert('Failed to delete all users');
          btn.disabled = false;
        });
    }
  </script>
</body>

</html>